<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  

  

  

  

  

  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />





  <link rel="alternate" href="/atom.xml" title="wy521angel的博客" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico?v=5.1.2" />






<meta name="description" content="View Holder、Recyclerview 缓存机制、RecyclerView 性能优化策略">
<meta property="og:type" content="article">
<meta property="og:title" content="RecyclerView 详解">
<meta property="og:url" content="http://yoursite.com/2020/01/03/IT/Android/View%20%E6%8E%A7%E4%BB%B6/RecyclerView%E8%AF%A6%E8%A7%A3/index.html">
<meta property="og:site_name" content="wy521angel的博客">
<meta property="og:description" content="View Holder、Recyclerview 缓存机制、RecyclerView 性能优化策略">
<meta property="og:image" content="https://github.com/wy521angel/MarkdowmPhotos/blob/master/IT/Android/View%20%E6%8E%A7%E4%BB%B6/no%20View%20holder.png?raw=true">
<meta property="og:image" content="https://github.com/wy521angel/MarkdowmPhotos/blob/master/IT/Android/View%20%E6%8E%A7%E4%BB%B6/with%20view%20holder.png?raw=true">
<meta property="og:image" content="https://github.com/wy521angel/MarkdowmPhotos/blob/master/IT/Android/View%20%E6%8E%A7%E4%BB%B6/ListView%E7%BC%93%E5%AD%98%E5%9B%BE%E7%A4%BA1.png?raw=true">
<meta property="og:image" content="https://github.com/wy521angel/MarkdowmPhotos/blob/master/IT/Android/View%20%E6%8E%A7%E4%BB%B6/ListView%E7%BC%93%E5%AD%98%E5%9B%BE%E7%A4%BA2.png?raw=true">
<meta property="og:image" content="https://github.com/wy521angel/MarkdowmPhotos/blob/master/IT/Android/View%20%E6%8E%A7%E4%BB%B6/Recyclerview%E7%BC%93%E5%AD%98%E5%9B%BE%E7%A4%BA1.png?raw=true">
<meta property="og:image" content="https://github.com/wy521angel/MarkdowmPhotos/blob/master/IT/Android/View%20%E6%8E%A7%E4%BB%B6/Recyclerview%E7%BC%93%E5%AD%98%E5%9B%BE%E7%A4%BA2.png?raw=true">
<meta property="og:image" content="https://github.com/wy521angel/MarkdowmPhotos/blob/master/IT/Android/View%20%E6%8E%A7%E4%BB%B6/DiffUtil.Callback%20%E9%80%BB%E8%BE%91%E5%9B%BE.png?raw=true">
<meta property="article:published_time" content="2020-01-02T16:00:00.000Z">
<meta property="article:modified_time" content="2020-03-07T03:24:46.000Z">
<meta property="article:author" content="wy521angel">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://github.com/wy521angel/MarkdowmPhotos/blob/master/IT/Android/View%20%E6%8E%A7%E4%BB%B6/no%20View%20holder.png?raw=true">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2020/01/03/IT/Android/View 控件/RecyclerView详解/"/>





  <title>RecyclerView 详解 | wy521angel的博客</title>
  














<meta name="generator" content="Hexo 4.2.1"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">wy521angel的博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">一个从事IT工作的伪文艺青年</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-photo">
          <a href="/photo/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-camera"></i> <br />
            
            相册
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/01/03/IT/Android/View%20%E6%8E%A7%E4%BB%B6/RecyclerView%E8%AF%A6%E8%A7%A3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="wy521angel">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/myavatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="wy521angel的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">RecyclerView 详解</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-01-03T00:00:00+08:00">
                2020-01-03
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/IT/" itemprop="url" rel="index">
                    <span itemprop="name">IT</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/IT/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/IT/Android/View-%E6%8E%A7%E4%BB%B6/" itemprop="url" rel="index">
                    <span itemprop="name">View 控件</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/IT/Android/View-%E6%8E%A7%E4%BB%B6/RecyclerView/" itemprop="url" rel="index">
                    <span itemprop="name">RecyclerView</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2020/01/03/IT/Android/View%20%E6%8E%A7%E4%BB%B6/RecyclerView%E8%AF%A6%E8%A7%A3/" class="leancloud_visitors" data-flag-title="RecyclerView 详解">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计</span>
                
                <span title="字数统计">
                  
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长</span>
                
                <span title="阅读时长">
                  
                </span>
              
            </div>
          

          
              <div class="post-description">
                  View Holder、Recyclerview 缓存机制、RecyclerView 性能优化策略
              </div>
          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="RecyclerView-的优势"><a href="#RecyclerView-的优势" class="headerlink" title="RecyclerView 的优势"></a>RecyclerView 的优势</h1><ul>
<li>默认支持 Linear、Grid、Staggered Grid 三种布局</li>
<li>友好的 ItemAnimator 动画 API</li>
<li>强制实现 ViewHolder</li>
<li>解耦的架构设计</li>
<li>相比 ListView 更好的性能</li>
</ul>
<h1 id="View-Holder"><a href="#View-Holder" class="headerlink" title="View Holder"></a>View Holder</h1><h2 id="View-holder-是什么"><a href="#View-holder-是什么" class="headerlink" title="View holder 是什么"></a>View holder 是什么</h2><p>&#160; &#160; &#160; &#160;下图是 ListView 中没有实现 View Holder 的 getView()，findViewById() 方法会执行很多次，列表在不断滑动，每次 getView() 时，都会执行。findViewById() 的底层实现为 DFS（深度优先搜索算法），时间复杂度为O(!n)</p>
<p><img src="https://github.com/wy521angel/MarkdowmPhotos/blob/master/IT/Android/View%20%E6%8E%A7%E4%BB%B6/no%20View%20holder.png?raw=true" alt="没有实现 View Holder 的 getView()"></p>
<p>&#160; &#160; &#160; &#160;下图是实现了 View Holder 的 getView()，这也是 View Holder 名字的来历，用来保存 view 引用的容器类。每当创建 convertView 时，同时创建一个对应的 ViewHolder 对象，然后将 convertView 以及它的子 view 全部存入该对象，同时将 convertView 和 ViewHolder 通过 View.setTag() 方法绑定起来。当 convertView 为空时才会执行 findViewById，如果不为空，即该 convertView 是被复用的，之前用过被回收，此时再次返回来使用，直接通过 getTag() 将 ViewHolder 取出来。下面数据绑定的过程全部是通过 holder 里面的子 view 来完成的。</p>
<p><img src="https://github.com/wy521angel/MarkdowmPhotos/blob/master/IT/Android/View%20%E6%8E%A7%E4%BB%B6/with%20view%20holder.png?raw=true" alt="实现了 view holder 的 getView()"></p>
<p>&#160; &#160; &#160; &#160;Item View 和 View Holder 是一一对应的关系。创建一个 Item View 时，同时创建一个 View Holder，并且将 View Holder 放到 Item View 里面。后面用到 View Holder，拿到 Item View 再将它取出来。是否复用 Item View 和使用 View Holder 没有关系，即便不使用 View Holder，一样在复用 Item View，只是 findViewById() 比较耗性能。</p>
<p>&#160; &#160; &#160; &#160;在 RecyclerView 中，View Holder 除了解决 findViewById() 的性能问题，还保存了一些和 Item 相关的信息，比如 Item 的位置信息。 RecyclerView 的 View Holder 和 ListView 的设计理念是一样的，防止重复 findViewById()，提升效率。</p>
<h2 id="View-holder-最佳实践"><a href="#View-holder-最佳实践" class="headerlink" title="View holder 最佳实践"></a>View holder 最佳实践</h2><p>&#160; &#160; &#160; &#160;对于 viewType 种类多的 View ，可以将具体的绑定逻辑写到对应的 ViewHolder 里面，如下代码所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">UserViewHolder</span> <span class="keyword">extends</span> <span class="title">RecyclerView</span>.<span class="title">ViewHolder</span> </span>&#123;</span><br><span class="line">    ImageView avatar;</span><br><span class="line">    TextView name;</span><br><span class="line"></span><br><span class="line">    UserViewHolder(<span class="meta">@NonNull</span> View itemView) &#123;</span><br><span class="line">        <span class="keyword">super</span>(itemView);</span><br><span class="line">        avatar = itemView.findViewById(R.id.avatar);</span><br><span class="line">        name = itemView.findViewById(R.id.name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">bindTo</span><span class="params">(User user)</span></span>&#123;</span><br><span class="line">        <span class="comment">// bind data to UI</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//    public void onBindViewHolder(UserViewHolder holder, int position) &#123;</span></span><br><span class="line"><span class="comment">//        holder.bindTo(userList.get(position));</span></span><br><span class="line"><span class="comment">//    &#125;</span></span><br></pre></td></tr></table></figure>

<h1 id="Recyclerview-缓存机制"><a href="#Recyclerview-缓存机制" class="headerlink" title="Recyclerview 缓存机制"></a>Recyclerview 缓存机制</h1><h2 id="ListView-的缓存"><a href="#ListView-的缓存" class="headerlink" title="ListView 的缓存"></a>ListView 的缓存</h2><p>&#160; &#160; &#160; &#160;ListView 通过一个 RecycleBin 的类来管理 Item View，在 RecycleBin 中有两层缓存，第一层是 Active View，第二层是 Scrap View。需要 View 时，先从 Active View 中寻找并返回，如果没有，再从 Scrap View 中找。Active View 即“活动”的 View，在屏幕内部的 View，滑动过程中用户看到的 View；Scrap View 是“废弃”的 View，指的是已经从屏幕当中移出去的 View，已经被回收，放入了 RecycleBin 中。如果两层缓存都没找到，则 Create View，调用用户自己创建 View。</p>
<p><img src="https://github.com/wy521angel/MarkdowmPhotos/blob/master/IT/Android/View%20%E6%8E%A7%E4%BB%B6/ListView%E7%BC%93%E5%AD%98%E5%9B%BE%E7%A4%BA1.png?raw=true" alt="ListView 缓存图示1"></p>
<p><img src="https://github.com/wy521angel/MarkdowmPhotos/blob/master/IT/Android/View%20%E6%8E%A7%E4%BB%B6/ListView%E7%BC%93%E5%AD%98%E5%9B%BE%E7%A4%BA2.png?raw=true" alt="ListView 缓存图示2"></p>
<p>&#160; &#160; &#160; &#160;Android 的刷新频率是16.6ms，ListView 在屏幕渲染时，会将所有的 Item View 给清空掉，然后再根据最新状态渲染到页面上。被清除掉的这部分 Item 事实上除了位置不同，其它的都相同，这部分 Item 不需要重新绑定数据，ListView 就会跳过 Adapter 的 getView() 的调用。凡是重新复用的不需要绑定数据的 Item View 会跳过 getView() 的调用，凡是调用了 getView() 都需要进行数据绑定的操作。</p>
<h2 id="Recyclerview-的缓存"><a href="#Recyclerview-的缓存" class="headerlink" title="Recyclerview 的缓存"></a>Recyclerview 的缓存</h2><p>&#160; &#160; &#160; &#160;Recyclerview 通过 Recycler 来管理缓存，ListView 缓存的是 Item View，即那个 View 对象，Recyclerview 缓存的是 ViewHolder。但二者没有本质区别，因为 Item View 和 View Holder 是一一对应相互绑定的。</p>
<p>&#160; &#160; &#160; &#160;Recyclerview 有四层缓存，如果需要一个 View，会沿着1-4的顺序找，最上层的 Scrap 对应的是 ListView 的 Active View ，对于 Recyclerview 来说，Scrap 就是屏幕内的 Item View。ViewCaCheExtension 这一层，是用户自定义的 Cache 策略，如果用户没有定义，则直接到第四层。如果没有，最终会调用到 Adapter 的 onCreateViewHolder，用户创建 Item View 和 View Holder 绑定起来，返回给系统。</p>
<p><img src="https://github.com/wy521angel/MarkdowmPhotos/blob/master/IT/Android/View%20%E6%8E%A7%E4%BB%B6/Recyclerview%E7%BC%93%E5%AD%98%E5%9B%BE%E7%A4%BA1.png?raw=true" alt="Recyclerview 缓存图示1"></p>
<p><img src="https://github.com/wy521angel/MarkdowmPhotos/blob/master/IT/Android/View%20%E6%8E%A7%E4%BB%B6/Recyclerview%E7%BC%93%E5%AD%98%E5%9B%BE%E7%A4%BA2.png?raw=true" alt="Recyclerview 缓存图示2"></p>
<p>&#160; &#160; &#160; &#160;屏幕内的第一层缓存 Scrap View 是可以直接复用的，不需要重新绑定数据。这种可以直接复用的 View 是通过数据集的 position 来找到对应的 View 的。Recyclerview 会将刚刚移出屏幕的几个（默认是2，可以自己设置） Item View 放入到 Cache 缓存中，它和第一层是差不多的，可以直接复用，也是通过 position 找到 Cache 中的 Item View，不需要重新绑定。ViewCaCheExtension 用户自定义的缓存，使用不多，RecycledViewPool 是所有被废弃的 Item View 的池子，它里面 Item View 上的数据都是“脏”的，它是通过 View Type 来找缓存的，因为数据是脏的，所以需要重新绑定数据，也就是说不走 onCreateViewHolder，但是会走 onBindViewHolder。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Scrap 和 Cache 通过 position 找到缓存，并且数据是“干净”的，所以不需要重新绑定数据；</span><br><span class="line">RecycledViewPool 是通过 ViewType 找缓存的，数据是“脏”的，需要重新绑定数据。</span><br></pre></td></tr></table></figure>

<h1 id="ViewCacheExtension-使用场景"><a href="#ViewCacheExtension-使用场景" class="headerlink" title="ViewCacheExtension 使用场景"></a>ViewCacheExtension 使用场景</h1><p>&#160; &#160; &#160; &#160;广告卡片。列表内的广告数据可能和列表数据是分开的，二者需要请求不同的 API，而对于每一页，一共有4个广告，并且这些广告短期内不会发生变化。每次滑入一个广告卡片，一般情况下都需要重新绑定，广告卡片渲染比较耗时，影响性能。对于 Cache，它只关心 position，不关心 View Type，它缓存的是最近滑出去的 View，不可能缓存这四个广告卡片（四个广告卡片的距离相对来说比较远），RecycledViewPool 只关心 View Type，View 都需要重新绑定，而所有卡片都重新绑定，很耗性能。所以在 ViewCacheExtension 里保持4个广告 Card 缓存。这样不需要每次都绑定，可以拿来直接使用，从而提升效率。</p>
<h1 id="列表中-item-广告的-impression-统计"><a href="#列表中-item-广告的-impression-统计" class="headerlink" title="列表中 item/广告的 impression 统计"></a>列表中 item/广告的 impression 统计</h1><p>&#160; &#160; &#160; &#160;ListView 通过 getView() 统计是正确的，ListView 在 getView() 时，就是用户看到它的时候，看到一次调用一次，数值是正确的；而 Recyclerview 在 onBindViewHolder 方法中统计是错误的，在有些情况下，用户滑出屏幕又滑回来（前面提到的 Cache），不走 onBindViewHolder，这种情况下，有可能发生用户看了10次广告而统计了8次。Recyclerview 的 AdapterView 里面，有 onViewAttachedToWindow() 方法，View 进入可见区域，就会回调该方法，使用该方法来统计。</p>
<h1 id="RecyclerView-性能优化策略"><a href="#RecyclerView-性能优化策略" class="headerlink" title="RecyclerView 性能优化策略"></a>RecyclerView 性能优化策略</h1><h2 id="不要在-onBindViewHolder-里设置点击监听"><a href="#不要在-onBindViewHolder-里设置点击监听" class="headerlink" title="不要在 onBindViewHolder 里设置点击监听"></a>不要在 onBindViewHolder 里设置点击监听</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SimpleAdapter</span> <span class="keyword">extends</span> <span class="title">RecyclerView</span>.<span class="title">Adapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ViewHolder <span class="title">onCreateViewHolder</span><span class="params">(ViewGroup parent, <span class="keyword">int</span> viewType)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onBindViewHolder</span><span class="params">(ViewHolder holder, <span class="keyword">int</span> position)</span> </span>&#123;</span><br><span class="line">        holder.itemView.setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</span><br><span class="line">                ...</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>&#160; &#160; &#160; &#160;上面代码在 onBindviewholder 里设置点击监听器会导致重复创建对象，所以需要在 onCreateViewHolder 里设置点击监听，View、ViewHolder、View.OnClickListener 三者一一对应。类似如下代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SimpleAdapter</span> <span class="keyword">extends</span> <span class="title">RecyclerView</span>.<span class="title">Adapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ViewHolder <span class="title">onCreateViewHolder</span><span class="params">(ViewGroup parent, <span class="keyword">int</span> viewType)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> SimpleViewHolder holder = <span class="keyword">new</span> SimpleViewHolder();</span><br><span class="line">        holder.itemView.setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</span><br><span class="line">                ...</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onBindViewHolder</span><span class="params">(ViewHolder holder, <span class="keyword">int</span> position)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="使用-LinearLayoutManager-setInitialPrefetchItemCount"><a href="#使用-LinearLayoutManager-setInitialPrefetchItemCount" class="headerlink" title="使用 LinearLayoutManager.setInitialPrefetchItemCount()"></a>使用 LinearLayoutManager.setInitialPrefetchItemCount()</h2><p>&#160; &#160; &#160; &#160;用户滑动到横向滑动的 item Recyclerview 的时候(Recyclerview 嵌套，内部还是一个 Recyclerview)，由于需要创建更复杂的 Recyclerview 以及多个子 view，可能会导致页面卡顿。由于 RenderThread 的存在，RecyclerView 会进行 prefetch（预加载）。对于嵌套 RecyclerView 要得到最佳性能，在内层 LayoutManager 上调用 LinearLayoutManager 的新方法 setInitialItemPrefetchCount()（v25.1可用）。它表示横向列表初次显示时可见的 item 个数。比如，如果一个垂直列表最少能显示3个以上的 item，调用 setInitialItemPrefetchCount(4)。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">只有 LinearLayoutManager 有这个 API</span><br><span class="line">只有嵌套在内部的 Recyclerview 使用才会生效</span><br></pre></td></tr></table></figure>

<p>&#160; &#160; &#160; &#160;如果自己实现 LayoutManager 的话，需要重写 LayoutManager.collectAdjacentPrefetchPositions()，因为 prefetch 开启的时候 RecyclerView 会调用这个方法，而它默认的实现什么也没做。同样当 RecyclerView 是嵌套在另一个 RecyclerView 中的时候，要想它的 LayoutManager 发生预取行为，也要实现 LayoutManager.collectInitialPrefetchPositions()。</p>
<h2 id="RecyclerView-setHasFixedSize"><a href="#RecyclerView-setHasFixedSize" class="headerlink" title="RecyclerView.setHasFixedSize()"></a>RecyclerView.setHasFixedSize()</h2><p>&#160; &#160; &#160; &#160;如下面伪代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">onContentsChanged</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mHasFixedSize) &#123;</span><br><span class="line">        layoutChildren();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        requestLayout();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>&#160; &#160; &#160; &#160;RecyclerView 有固定尺寸，则 layoutChildren，否则 requestLayout。如果 Adapter 的数据变化不会导致 RecyclerView 的大小变化 RecyclerView.setHasFixedSize(true)。当我们确定 Item 的改变不会影响 RecyclerView 的宽高的时候可以设置 setHasFixedSize(true)，并通过 Adapter 的增删改插方法去刷新 RecyclerView，而不是通过 notifyDataSetChanged()。（其实可以直接设置为true，当需要改变宽高的时候就用 notifyDataSetChanged()去整体刷新一下）</p>
<h2 id="多个-RecyclerView-共用-RecycledViewPool"><a href="#多个-RecyclerView-共用-RecycledViewPool" class="headerlink" title="多个 RecyclerView 共用 RecycledViewPool"></a>多个 RecyclerView 共用 RecycledViewPool</h2><p>&#160; &#160; &#160; &#160;多个不同的 RecyclerView 之间共享 RecycledViewPool。代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">RecyclerView.RecycledViewPool recycledViewPool = <span class="keyword">new</span> RecyclerView.RecycledViewPool();</span><br><span class="line">recycledView1.setRecycledViewPool(recycledViewPool);</span><br><span class="line">recycledView2.setRecycledViewPool(recycledViewPool);</span><br><span class="line">recycledView3.setRecycledViewPool(recycledViewPool);</span><br></pre></td></tr></table></figure>

<h1 id="DiffUtil"><a href="#DiffUtil" class="headerlink" title="DiffUtil"></a>DiffUtil</h1><h2 id="DiffUtil-使用"><a href="#DiffUtil-使用" class="headerlink" title="DiffUtil 使用"></a>DiffUtil 使用</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Callback</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">int</span> <span class="title">getOldListSize</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">int</span> <span class="title">getNewListSize</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">boolean</span> <span class="title">areItemsTheSame</span><span class="params">(<span class="keyword">int</span> var1, <span class="keyword">int</span> var2)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">boolean</span> <span class="title">areContentsTheSame</span><span class="params">(<span class="keyword">int</span> var1, <span class="keyword">int</span> var2)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getChangePayload</span><span class="params">(<span class="keyword">int</span> oldItemPosition, <span class="keyword">int</span> newItemPosition)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>&#160; &#160; &#160; &#160;这是给系统用于计算 Diff 的 Callback，以 User 为例，areItemsTheSame 指的是在逻辑上是否是同一个人，比如 ID 相同就是同一个人，即同一个 Item；areContentsTheSame 指两个 Item 的内容是否相同，只有在同一个人的情况下，再比较其中的内容是否相同。比如两个 User 是同一个人，但新的列表里面的 User 年龄修改了，返回 false；如果 areContentsTheSame 返回 false，同一个人但其中的一些属性不一样了，在 getChangePayload 方法中判断究竟是哪里发生了变化。</p>
<p>&#160; &#160; &#160; &#160;DiffUtil.Callback 逻辑如下图所示：</p>
<p><img src="https://github.com/wy521angel/MarkdowmPhotos/blob/master/IT/Android/View%20%E6%8E%A7%E4%BB%B6/DiffUtil.Callback%20%E9%80%BB%E8%BE%91%E5%9B%BE.png?raw=true" alt="DiffUtil.Callback 逻辑图"></p>
<p>&#160; &#160; &#160; &#160;java 示例代码如下所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserDiffCallBack</span> <span class="keyword">extends</span> <span class="title">DiffUtil</span>.<span class="title">Callback</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> List&lt;User&gt; oldList;</span><br><span class="line">    <span class="keyword">private</span> List&lt;User&gt; newList;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">UserDiffCallBack</span><span class="params">(List&lt;User&gt; oldList, List&lt;User&gt; newList)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.oldList = oldList;</span><br><span class="line">        <span class="keyword">this</span>.newList = newList;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getOldListSize</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> oldList.size();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getNewListSize</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> newList.size();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">areItemsTheSame</span><span class="params">(<span class="keyword">int</span> oldItemPosition, <span class="keyword">int</span> newItemPosition)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> oldList.get(oldItemPosition).id == newList.get(newItemPosition).id;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">areContentsTheSame</span><span class="params">(<span class="keyword">int</span> oldItemPosition, <span class="keyword">int</span> newItemPosition)</span> </span>&#123;</span><br><span class="line">        User oldUser = oldList.get(oldItemPosition);</span><br><span class="line">        User newUser = newList.get(newItemPosition);</span><br><span class="line">        <span class="keyword">return</span> oldUser.id == newUser.id &amp;&amp;</span><br><span class="line">                oldUser.name.equals(newUser.name) &amp;&amp;</span><br><span class="line">                oldUser.profession.equals(newUser.profession);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>&#160; &#160; &#160; &#160;areContentsTheSame 中比较对象具体的内容，其实可以使用复写 equals 来简化代码，类似 oldUser.equals(newUser)。</p>
<p>&#160; &#160; &#160; &#160;getChangePayload 方法如下所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserDiffCallBack</span> <span class="keyword">extends</span> <span class="title">DiffUtil</span>.<span class="title">Callback</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">private</span> List&lt;User&gt; oldList;</span><br><span class="line">    <span class="keyword">private</span> List&lt;User&gt; newList;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getChangePayload</span><span class="params">(<span class="keyword">int</span> oldItemPosition, <span class="keyword">int</span> newItemPosition)</span> </span>&#123;</span><br><span class="line">        User oldUser = oldList.get(oldItemPosition);</span><br><span class="line">        User newUser = newList.get(newItemPosition);</span><br><span class="line">        Bundle payload = <span class="keyword">new</span> Bundle();</span><br><span class="line">        <span class="keyword">if</span> (!oldUser.name.equals(newUser.name)) &#123;</span><br><span class="line">            payload.putString(User.KEY_NAME, newUser.name);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!oldUser.profession.equals(newUser.profession)) &#123;</span><br><span class="line">            payload.putString(User.KEY_PROF, newUser.profession);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (payload.size() == <span class="number">0</span>) <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">return</span> payload;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>&#160; &#160; &#160; &#160;getChangePayload 方法并非必须实现的，如果不实现，就不会有 Item 内部的增量更新了，对于系统来说，就会复用整个 Item；如果需要实现该方法，如上代码对比两个 User 的差异，放入 Bundle 内，Bundle 不是必须的，此处因为 Bundle 是 key-value 的结构，所以使用它保存。</p>
<p>&#160; &#160; &#160; &#160;Adapter 中使用 DiffUtil 的刷新方法如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ShowcaseRVAdapter</span> <span class="keyword">extends</span> <span class="title">RecyclerView</span>.<span class="title">Adapter</span>&lt;<span class="title">ShowcaseRVAdapter</span>.<span class="title">UserViewHolder</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> List&lt;User&gt; userList;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ShowcaseRVAdapter</span><span class="params">(List&lt;User&gt; userList)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.userList = userList;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">swapData</span><span class="params">(List&lt;User&gt; newList, <span class="keyword">boolean</span> diff)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (diff) &#123;</span><br><span class="line">            DiffUtil.DiffResult diffResult =</span><br><span class="line">                    DiffUtil.calculateDiff(<span class="keyword">new</span> UserDiffCallBack(userList, newList), <span class="keyword">false</span>);</span><br><span class="line">            userList = newList;</span><br><span class="line">            diffResult.dispatchUpdatesTo(<span class="keyword">this</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            userList = newList;</span><br><span class="line">            notifyDataSetChanged();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>&#160; &#160; &#160; &#160;两个参数是做完整绑定的方法，即全量更新，Item User里面的所有属性都需要绑定一次，而三个参数是做局部绑定的（以 name 为例），做增量更新，如下代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ShowcaseRVAdapter</span> <span class="keyword">extends</span> <span class="title">RecyclerView</span>.<span class="title">Adapter</span>&lt;<span class="title">ShowcaseRVAdapter</span>.<span class="title">UserViewHolder</span>&gt; </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onBindViewHolder</span><span class="params">(UserViewHolder holder, <span class="keyword">int</span> position)</span> </span>&#123;</span><br><span class="line">        User user = userList.get(position);</span><br><span class="line">        holder.name.setText(user.name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onBindViewHolder</span><span class="params">(UserViewHolder holder, <span class="keyword">int</span> position, List&lt;Object&gt; payloads)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (payloads.isEmpty()) &#123;</span><br><span class="line">            onBindViewHolder(holder, position);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Bundle payload = (Bundle) payloads.get(<span class="number">0</span>);</span><br><span class="line">            <span class="keyword">for</span> (String key : payload.keySet()) &#123;</span><br><span class="line">                <span class="keyword">switch</span> (key) &#123;</span><br><span class="line">                    <span class="keyword">case</span> User.KEY_NAME:</span><br><span class="line">                        holder.name.setText(payload.getString(key));</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="在列表很大的时候异步计算-diff"><a href="#在列表很大的时候异步计算-diff" class="headerlink" title="在列表很大的时候异步计算 diff"></a>在列表很大的时候异步计算 diff</h2><ul>
<li>使用 Thread/Handler 将 DiffResult 发送到主线程</li>
<li>使用 RxJava 将 calculateDiff 操作放到后台线程</li>
<li>使用 Google 提供的 AsyncListDiffer(Executor)/ListAdapter（这个 ListAdapter 是新的 RecyclerView 包下的）</li>
</ul>
<blockquote>
<p>参考资料：<br>腾讯课堂 HenCoder<br>泡在网上的日子 <a href="http://www.jcodecraeer.com/a/anzhuokaifa/androidkaifa/2017/0214/7113.html" target="_blank" rel="noopener">RecyclerView的新机制：预取（Prefetch）</a></p>
</blockquote>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/01/02/IT/Java/%E7%BA%BF%E7%A8%8B/%E6%AD%BB%E9%94%81/" rel="next" title="死锁">
                <i class="fa fa-chevron-left"></i> 死锁
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2020/01/03/IT/%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3/%E4%B9%90%E8%A7%82%E9%94%81%E4%B8%8E%E6%82%B2%E8%A7%82%E9%94%81/" rel="prev" title="乐观锁与悲观锁">
                乐观锁与悲观锁 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
        <!-- JiaThis Button BEGIN -->
<div class="jiathis_style">
  <a class="jiathis_button_tsina"></a>
  <a class="jiathis_button_tqq"></a>
  <a class="jiathis_button_weixin"></a>
  <a class="jiathis_button_cqq"></a>
  <a class="jiathis_button_douban"></a>
  <a class="jiathis_button_renren"></a>
  <a class="jiathis_button_qzone"></a>
  <a class="jiathis_button_kaixin001"></a>
  <a class="jiathis_button_copy"></a>
  <a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank"></a>
  <a class="jiathis_counter_style"></a>
</div>
<script type="text/javascript" >
  var jiathis_config={
    hideMore:false
  }
</script>
<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js" charset="utf-8"></script>
<!-- JiaThis Button END -->

      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div id="lv-container" data-id="city" data-uid="MTAyMC8zMDEwMS82NjU2"></div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/myavatar.jpg"
               alt="wy521angel" />
          <p class="site-author-name" itemprop="name">wy521angel</p>
           
              <p class="site-description motion-element" itemprop="description">存放一些IT技术积累</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">144</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">49</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">53</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        
          <div class="links-of-blogroll motion-element links-of-blogroll-inline">
            <div class="links-of-blogroll-title">
              <i class="fa  fa-fw fa-globe"></i>
              友情链接
            </div>
            <ul class="links-of-blogroll-list">
              
                <li class="links-of-blogroll-item">
                  <a href="http://blog.csdn.net/lmj623565791" title="Hongyang的博客" target="_blank">Hongyang的博客</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://blog.csdn.net/guolin_blog" title="郭霖的博客" target="_blank">郭霖的博客</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://blog.csdn.net/eclipsexys" title="eclipse_xu的博客" target="_blank">eclipse_xu的博客</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://blog.csdn.net/lovelion?viewmode=list" title="刘伟的博客" target="_blank">刘伟的博客</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="https://philipdroid.github.io" title="philipdroid的博客" target="_blank">philipdroid的博客</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://www.jcodecraeer.com" title="泡在网上的日子" target="_blank">泡在网上的日子</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="https://juejin.im/timeline" title="掘金" target="_blank">掘金</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://www.infoq.com/cn" title="InfoQ" target="_blank">InfoQ</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://www.uisdc.com" title="优设" target="_blank">优设</a>
                </li>
              
            </ul>
          </div>
        

<iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=330 height=86 src="//music.163.com/outchain/player?type=2&id=34341358&auto=0&height=66"></iframe>
        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#RecyclerView-的优势"><span class="nav-number">1.</span> <span class="nav-text">RecyclerView 的优势</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#View-Holder"><span class="nav-number">2.</span> <span class="nav-text">View Holder</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#View-holder-是什么"><span class="nav-number">2.1.</span> <span class="nav-text">View holder 是什么</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#View-holder-最佳实践"><span class="nav-number">2.2.</span> <span class="nav-text">View holder 最佳实践</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Recyclerview-缓存机制"><span class="nav-number">3.</span> <span class="nav-text">Recyclerview 缓存机制</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#ListView-的缓存"><span class="nav-number">3.1.</span> <span class="nav-text">ListView 的缓存</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Recyclerview-的缓存"><span class="nav-number">3.2.</span> <span class="nav-text">Recyclerview 的缓存</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#ViewCacheExtension-使用场景"><span class="nav-number">4.</span> <span class="nav-text">ViewCacheExtension 使用场景</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#列表中-item-广告的-impression-统计"><span class="nav-number">5.</span> <span class="nav-text">列表中 item&#x2F;广告的 impression 统计</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#RecyclerView-性能优化策略"><span class="nav-number">6.</span> <span class="nav-text">RecyclerView 性能优化策略</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#不要在-onBindViewHolder-里设置点击监听"><span class="nav-number">6.1.</span> <span class="nav-text">不要在 onBindViewHolder 里设置点击监听</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#使用-LinearLayoutManager-setInitialPrefetchItemCount"><span class="nav-number">6.2.</span> <span class="nav-text">使用 LinearLayoutManager.setInitialPrefetchItemCount()</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#RecyclerView-setHasFixedSize"><span class="nav-number">6.3.</span> <span class="nav-text">RecyclerView.setHasFixedSize()</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#多个-RecyclerView-共用-RecycledViewPool"><span class="nav-number">6.4.</span> <span class="nav-text">多个 RecyclerView 共用 RecycledViewPool</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#DiffUtil"><span class="nav-number">7.</span> <span class="nav-text">DiffUtil</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#DiffUtil-使用"><span class="nav-number">7.1.</span> <span class="nav-text">DiffUtil 使用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#在列表很大的时候异步计算-diff"><span class="nav-number">7.2.</span> <span class="nav-text">在列表很大的时候异步计算 diff</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">wy521angel</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io" target="_blank" rel="noopener">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next" target="_blank" rel="noopener">
    NexT.Pisces
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>

  
  <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.2"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  


  




	





  





  
    <script type="text/javascript">
      (function(d, s) {
        var j, e = d.getElementsByTagName(s)[0];
        if (typeof LivereTower === 'function') { return; }
        j = d.createElement(s);
        j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
        j.async = true;
        e.parentNode.insertBefore(j, e);
      })(document, 'script');
    </script>
  






  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("xVeur9szsyg7AkKwseQcBlqr-MdYXbMMI", "UEl3HMLcU0j2xYsHkUlJGVS8");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  

  

  

  
  <a href="https://github.com/wy521angel" target="_blank" rel="noopener"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://camo.githubusercontent.com/365986a132ccd6a44c23a9169022c0b5c890c387/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f7265645f6161303030302e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_red_aa0000.png"></a>
  
  
  <script type="text/javascript" src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js"></script>
  
</body>
</html>
